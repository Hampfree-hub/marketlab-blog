---
// ArticleGrid.astro - Плитка из последних статей блога
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

const posts = (await getCollection('blog'))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 5); // Берём 5 последних статей
---

<section class="article-grid-section">
	<h2 class="article-grid-title">Последние восстановленные материалы</h2>
	<p class="article-grid-subtitle">Истории создания технических индикаторов и другие эксперименты</p>
	
	<div class="article-grid">
		{posts.map((post, index) => (
			<article class="article-card" role="article" aria-labelledby={`article-title-${index}`}>
				<a href={`/blog/${post.id}/`} class="article-card-link" aria-label={`Читать статью: ${post.data.title}`}>
					{post.data.heroImage && (
						<div class="article-card-image">
							<Image 
								src={post.data.heroImage} 
								alt={post.data.title}
								width={400}
								height={200}
								loading="lazy"
							/>
						</div>
					)}
					<div class="article-card-content">
						<h3 class="article-card-title" id={`article-title-${index}`}>{post.data.title}</h3>
						{post.data.description && (
							<p class="article-card-description">{post.data.description}</p>
						)}
						{post.data.pubDate && (
							<time class="article-card-date">
								{new Date(post.data.pubDate).toLocaleDateString('ru-RU', {
									year: 'numeric',
									month: 'long',
									day: 'numeric'
								})}
							</time>
						)}
					</div>
				</a>
			</article>
		))}
	</div>
</section>

<style>
	.article-grid-section {
		background: var(--nes-white);
		border: var(--nes-border-width, 2px) solid var(--nes-black);
		border-radius: 4px;
		padding: var(--nes-spacing-lg, 24px); /* 24px - кратно 4px */
		margin-bottom: var(--nes-spacing-md, 16px); /* 16px - кратно 4px */
		/* БЕЗ теней - плоские элементы */
		max-width: 1200px;
		margin-left: auto;
		margin-right: auto;
	}

	.article-grid-title {
		font-family: 'Arial', sans-serif;
		font-size: 1.8rem;
		font-weight: bold;
		color: var(--nes-black);
		margin: 0 0 var(--nes-spacing-sm, 8px) 0; /* 8px - кратно 4px */
		text-align: center;
	}

	.article-grid-subtitle {
		font-family: 'Arial', sans-serif;
		font-size: 1rem;
		color: var(--nes-gray);
		margin: 0 0 var(--nes-spacing-lg, 24px) 0; /* 24px - кратно 4px */
		text-align: center;
	}

	.article-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
		gap: var(--nes-spacing-md, 16px); /* 16px - кратно 4px */
	}

	.article-card {
		background: var(--nes-white);
		/* Beveling для объёма */
		border-top: var(--nes-border-width, 2px) solid var(--nes-bevel-light, #FFFFFF);
		border-left: var(--nes-border-width, 2px) solid var(--nes-bevel-light, #FFFFFF);
		border-bottom: var(--nes-border-width, 2px) solid var(--nes-bevel-dark, #000000);
		border-right: var(--nes-border-width, 2px) solid var(--nes-bevel-dark, #000000);
		overflow: hidden; /* КРИТИЧНО: скрывает всё что выходит за границы (убирает зазоры) */
		transition: transform 0.15s ease, border 0.15s ease;
		/* БЕЗ теней - объём создаётся через beveling */
		border-radius: 4px; /* Сглаженные углы */
		/* Единый элемент - всё двигается синхронно */
		display: flex;
		flex-direction: column;
		/* ВАЖНО: все дочерние элементы двигаются вместе с родителем */
		margin: 0; /* Убираем все отступы */
		padding: 0; /* Убираем все отступы */
		/* КРИТИЧНО: Убираем все зазоры */
		box-sizing: border-box; /* Учитываем border в размерах */
		cursor: pointer; /* Указываем курсор для интерактивности */
	}

	.article-card:hover {
		/* Убираем изменение всего фона - только тонкая рамка */
		border-color: var(--nes-yellow);
		transform: translateY(-1px); /* Чуть выезжает вверх */
		/* Beveling сохраняется для объёма */
		/* Всё содержимое (картинка + контент) двигается как единое целое */
	}
	
	.article-card:hover .article-card-content {
		/* Только контентная область получает жёлтый фон при hover */
		background: var(--nes-yellow);
	}

	.article-card:active {
		transform: translateY(1px); /* Карточка прожимается вниз */
		/* Убираем beveling - все границы одинаковые (чёрные) чтобы не было белой полоски */
		border-top: var(--nes-border-width, 2px) solid var(--nes-bevel-dark, #000000) !important;
		border-left: var(--nes-border-width, 2px) solid var(--nes-bevel-dark, #000000) !important;
		border-bottom: var(--nes-border-width, 2px) solid var(--nes-bevel-dark, #000000) !important;
		border-right: var(--nes-border-width, 2px) solid var(--nes-bevel-dark, #000000) !important;
		border-color: var(--nes-bevel-dark, #000000) !important; /* Дополнительно переопределяем общий border-color */
		transition: transform 0.05s ease, border 0.05s ease;
	}

	/* Убираем жёлтый фон при активном состоянии (для светлой темы) */
	.article-card:active .article-card-content {
		background: var(--nes-white); /* Возвращаем белый фон */
	}

	/* Focus states для карточек статей */
	.article-card:focus {
		outline: var(--nes-border-width, 2px) solid var(--nes-blue);
		outline-offset: 2px;
		/* БЕЗ теней - плоские элементы */
	}

	.article-card:focus:not(:focus-visible) {
		outline: none;
		/* БЕЗ теней - плоские элементы */
	}

	.article-card-link {
		text-decoration: none;
		color: inherit;
		display: block;
		margin: 0; /* Убираем все отступы */
		padding: 0; /* Убираем все отступы */
		border: none; /* Убираем границы */
	}

	.article-card-image {
		width: calc(100% + 6px); /* Увеличиваем на 3px с каждой стороны для наезда на рамку */
		height: calc(200px + 6px); /* Увеличиваем на 3px сверху и снизу для наезда на рамку */
		margin: -3px -3px 0 -3px; /* Отрицательный margin для наезда на рамку родительской карточки */
		overflow: hidden; /* КРИТИЧНО: скрывает всё что выходит за границы (убирает зазоры) */
		background: var(--nes-gray);
		border-radius: 0; /* УБИРАЕМ border-radius - изображение должно заполнять углы родительской карточки */
		flex-shrink: 0; /* Фиксированный размер, не сжимается */
		/* КРИТИЧНО: НЕТ transition, transform, position - двигается строго вместе с родителем */
		transition: none !important;
		transform: none !important;
		position: relative !important; /* Для абсолютного позиционирования img */
		padding: 0; /* Убираем все отступы */
		border: none; /* Убираем границы (граница только у родителя) */
		/* КРИТИЧНО: Убираем все зазоры по углам и границам */
		line-height: 0; /* Убираем зазор снизу у изображения */
		display: block; /* Блочный элемент */
		box-sizing: border-box; /* Учитываем border в размерах */
		/* КРИТИЧНО: Контейнер должен быть прямоугольным для полного заполнения изображением */
		position: relative; /* Для правильного позиционирования img */
	}

	/* Стили для компонента Image из Astro - КРИТИЧНО: прилепить к фрейму без зазоров */
	.article-card-image :global(img),
	.article-card-image :global(picture),
	.article-card-image :global(picture img),
	.article-card-image img {
		/* КРИТИЧНО: Изображение должно полностью заполнять контейнер без зазоров по периметру */
		position: absolute !important; /* Абсолютное позиционирование для полного заполнения */
		top: 0 !important;
		left: 0 !important;
		right: 0 !important;
		bottom: 0 !important;
		width: 100% !important;
		height: 100% !important;
		object-fit: cover !important; /* Заполняет весь контейнер без белых областей */
		object-position: center !important; /* Центрируем изображение */
		image-rendering: pixelated;
		image-rendering: -moz-crisp-edges;
		image-rendering: crisp-edges;
		border-radius: 0 !important; /* КРИТИЧНО: УБИРАЕМ border-radius - заполняем углы родительской карточки */
		display: block !important; /* Убираем лишние отступы */
		margin: 0 !important; /* Убираем все отступы */
		padding: 0 !important; /* Убираем все отступы */
		border: none !important; /* Убираем границы */
		/* КРИТИЧНО: НЕТ transition, transform - двигается строго вместе с родителем */
		transition: none !important;
		transform: none !important;
		/* КРИТИЧНО: Убираем все зазоры */
		line-height: 0 !important; /* Убираем зазор снизу */
		vertical-align: top !important; /* Убираем зазор снизу */
		/* КРИТИЧНО: Изображение должно точно соответствовать контейнеру */
		box-sizing: border-box !important; /* Учитываем padding/border в размерах */
		/* КРИТИЧНО: Изображение должно полностью заполнять контейнер, включая углы - увеличиваем для перекрытия рамки */
		width: calc(100% + 6px) !important; /* Увеличение для заполнения углов и перекрытия рамки (3px * 2) */
		height: calc(100% + 6px) !important; /* Увеличение для заполнения углов и перекрытия рамки (3px * 2) */
		top: -3px !important; /* Смещение для заполнения верхнего угла и перекрытия верхней рамки */
		left: -3px !important; /* Смещение для заполнения левого угла и перекрытия левой рамки */
	}

	.article-card-content {
		padding: var(--nes-spacing-md, 16px); /* 16px - кратно 4px */
		flex: 1;
		/* КРИТИЧНО: НЕТ transition, transform - двигается строго вместе с родителем */
		transition: background-color 0.15s ease !important; /* Только для плавного изменения фона */
		transform: none !important;
	}

	.article-card-title {
		font-family: 'Arial', sans-serif;
		font-size: 1.1rem;
		font-weight: bold;
		color: var(--nes-black);
		margin: 0 0 var(--nes-spacing-sm, 8px) 0; /* 8px - кратно 4px */
		line-height: 1.4;
	}

	.article-card-description {
		font-family: 'Arial', sans-serif;
		font-size: 0.9rem;
		color: var(--nes-gray);
		margin: 0 0 var(--nes-spacing-sm, 8px) 0; /* 8px - кратно 4px */
		line-height: 1.6;
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.article-card-date {
		font-family: var(--nes-font);
		font-size: 0.7rem;
		color: var(--nes-gray);
		display: block;
	}

	/* Мобильная адаптация */
	@media (max-width: 768px) {
		.article-grid {
			grid-template-columns: 1fr;
		}
		
		.article-grid-section {
			padding: var(--nes-spacing-md, 16px); /* 16px - кратно 4px */
			margin-bottom: var(--nes-spacing-md, 16px); /* 16px - кратно 4px */
		}
		
		.article-grid-title {
			font-size: 1.5rem;
		}
	}
	
	/* Мобильные интерактивные элементы - активное состояние при нажатии */
	@media (max-width: 768px) {
		.article-card:active {
			transform: translateY(1px); /* Карточка прожимается вниз */
			/* БЕЗ теней - плоские элементы */
			transition: transform 0.05s ease;
		}
	}

	/* ТЁМНАЯ ТЕМА: Карточки статей */
	html.dark-theme .article-card {
		background: var(--nes-bg-card, #1a2a1a);
		border-color: rgba(0, 255, 65, 0.3); /* Приглушённый неоновый зелёный */
	}

	html.dark-theme .article-card:hover {
		border-color: var(--nes-neon-green, #00ff41);
	}

	html.dark-theme .article-card:hover .article-card-content {
		background: rgba(0, 255, 65, 0.1); /* Приглушённый неоновый зелёный фон */
	}

	html.dark-theme .article-card-content {
		background: var(--nes-bg-card, #1a2a1a);
	}

	html.dark-theme .article-card-title {
		color: var(--nes-neon-green, #00ff41);
	}

	html.dark-theme .article-card-description {
		color: var(--nes-text-light, #e5e5e5);
	}

	html.dark-theme .article-card-date {
		color: var(--nes-text-muted, #999999);
	}

	html.dark-theme .article-grid-title,
	html.dark-theme .article-grid-subtitle {
		color: var(--nes-neon-green, #00ff41);
	}

	html.dark-theme .article-grid-description {
		color: var(--nes-text-light, #e5e5e5);
	}

	html.dark-theme .article-grid-section {
		background: var(--nes-bg-card, #1a2a1a);
		border-color: rgba(0, 255, 65, 0.3);
	}

	html.dark-theme .article-grid-subtitle {
		color: var(--nes-text-muted, #999999);
	}

	/* ТЁМНАЯ ТЕМА: Активное состояние карточек (без белой полосы) */
	html.dark-theme .article-card:active {
		border-top: var(--nes-border-width, 2px) solid rgba(0, 255, 65, 0.5);
		border-left: var(--nes-border-width, 2px) solid rgba(0, 255, 65, 0.5);
		border-bottom: var(--nes-border-width, 2px) solid rgba(0, 255, 65, 0.5);
		border-right: var(--nes-border-width, 2px) solid rgba(0, 255, 65, 0.5);
	}

	html.dark-theme .article-card:active .article-card-content {
		background: var(--nes-bg-card, #1a2a1a); /* Возвращаем тёмный фон */
	}
</style>




